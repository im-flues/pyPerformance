<!DOCTYPE html>
<html>
<head>
    <title>Machinist Performance Dashboard</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        h1, h2 {
            text-align: center;
        }
        #timestamp {
            text-align: center;
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
        }
        #performanceChartContainer {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            margin-right: 20px;
            width: 80%;
        }
        #performanceChart {
            width: 70%;
            height: 70%; /* Fixed height to maintain readability */
        }
        ul {
            list-style-type: none;
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            margin-top: 20px;
        }
        li {
            margin: 0 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        li span {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        #refreshButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            border-radius: 5px;
        }
        #refreshButton:hover {
            background-color: #45a049;
        }
        /* Loading Indicator Styles */
        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            #performanceChart {
                height: 400px; /* Adjust height for smaller screens */
            }
            li {
                margin: 10px;
                font-size: 14px;
            }
            #refreshButton {
                width: 90%;
            }
        }
    </style>
    <script>
        // Function to refresh the page every 30 seconds
        function autoRefresh() {
            setInterval(function(){
                window.location.reload();
            }, 30000); // 30 seconds
        }

        // Initialize auto-refresh when the page loads
        window.onload = autoRefresh;
    </script>
</head>
<body>
    <h1>Machinist Performance Dashboard</h1>
    <div id="timestamp"></div>
    <div id="performanceChartContainer">
        <canvas id="performanceChart"></canvas>
    </div>
    <button id="refreshButton" onclick="window.location.reload();">Refresh Data</button> <!-- Manual Refresh Button -->

    <!-- Loading Indicator -->
    <div id="loading">
        <p>Loading data...</p>
    </div>

    <script>
        // Register the Data Labels plugin
        Chart.register(ChartDataLabels);

        // Initialize global variables
        let performanceChart; // To store the Chart.js instance

        // Function to update the timestamp
        function updateTimestamp() {
            const now = new Date();
            const options = {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true
            };
            const formattedTime = now.toLocaleString('en-US', options);
            document.getElementById('timestamp').innerText = `Last updated: ${formattedTime}`;
        }

        // Function to fetch data and update the chart
        async function fetchDataAndUpdateChart() {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'block';

                // Fetch data from the backend
                const response = await fetch(`/machinist-performance?t=${new Date().getTime()}`);
                const result = await response.json();

                if (result.status === 'success') {
                    let data = result.data;

                    if (data.length === 0) {
                        console.warn('No data available to display.');
                        // Clear the chart if no data
                        if (performanceChart) {
                            performanceChart.data.labels = [];
                            performanceChart.data.datasets.forEach(dataset => {
                                dataset.data = [];
                            });
                            performanceChart.update();
                        }
                        updateTimestamp(); // Update timestamp even if no data
                        document.getElementById('loading').style.display = 'none'; // Hide loading
                        return;
                    }

                    // Extract data into respective arrays
                    const labels = data.map(item => item.NAME);
                    const units = data.map(item => parseFloat(item.UNITS) || 0);
                    const performancePercentages = data.map(item => parseFloat(item.PerformancePercentage) || 0);

                    // Assign colors based on performance percentage
                    const barColors = performancePercentages.map(percentage => {
                        if (percentage >= 100) {
                            return 'rgba(10, 255, 92, 0.7)'; // Green for Performance >= 100%
                        } else if (percentage >= 80 && percentage < 100) {
                            return 'rgba(247, 200, 0, 0.7)'; // Yellow for Performance 80-100%
                        } else if (percentage >= 60 && percentage < 80) {
                            return 'rgba(255, 12, 13, 0.7)'; // Red for Performance 60-80%
                        } else {
                            return 'rgba(0, 0, 0, 0.7)'; // Black for Performance < 60%
                        }
                    });

                    if (!performanceChart) {
                        // Initialize the chart if it hasn't been created yet
                        const ctx = document.getElementById('performanceChart').getContext('2d');
                        performanceChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Units Produced',
                                        data: units,
                                        backgroundColor: barColors,
                                        borderColor: barColors,
                                        borderWidth: 1,
                                    }
                                ],
                            },
                            options: {
                                responsive: true,  
                                maintainAspectRatio: false,  
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Machinist',
                                        },
                                    },
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Units Produced',
                                        },
                                    },
                                },
                                plugins: {
                                    datalabels: {
                                        anchor: 'end',
                                        align: 'top',
                                        formatter: function(value, context) {
                                            let performance = performancePercentages[context.dataIndex];
                                            return `${performance.toFixed(2)}%`;
                                        },
                                        color: '#000',
                                        font: {
                                            weight: 'bold',
                                            size: '14'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Machinist Performance',
                                        font: {
                                            size: 20
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            afterLabel: function(context) {
                                                const index = context.dataIndex;
                                                let performance = performancePercentages[index];
                                                return [
                                                    'Performance: ' + performance.toFixed(2) + '%',
                                                ];
                                            },
                                            label: function(context) {
                                                return `Units Produced: ${context.parsed.y}`;
                                            }
                                        },
                                    },
                                },
                            },
                            plugins: [ChartDataLabels] // Register the Data Labels plugin
                        });
                        console.log('Chart initialized.');
                    } else {
                        // Update the existing chart with new data
                        performanceChart.data.labels = labels;
                        performanceChart.data.datasets[0].data = units;
                        performanceChart.data.datasets[0].backgroundColor = barColors;
                        performanceChart.data.datasets[0].borderColor = barColors;

                        performanceChart.update();
                        console.log('Chart updated.');
                    }

                    // Update the timestamp after successful data fetch
                    updateTimestamp();
                } else {
                    console.error('Error fetching data:', result.message);
                }
            } catch (error) {
                console.error('Fetch error:', error);
            } finally {
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Initial data fetch and chart rendering
        fetchDataAndUpdateChart();

        // Set up auto-refresh using setInterval (every 30 seconds)
        setInterval(fetchDataAndUpdateChart, 30000); // 30000 milliseconds = 30 seconds

        // Manual Refresh Button
        document.getElementById('refreshButton').addEventListener('click', () => {
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            // Fetch data and update chart
            fetchDataAndUpdateChart();
        });
    </script>
</body>
</html>
