<!DOCTYPE html>
<html>
<head>
    <title>Pick Performance Dashboard</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        h1, h2 {
            text-align: center;
        }
        #timestamp {
            text-align: center;
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
        }
        #pickChartContainer {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        #pickChart {
            width: 100%;
            max-width: 800px;
            height: auto; /* Let height adjust automatically */
        }
        ul {
            list-style-type: none;
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        li {
            margin: 5px 10px; /* Adjusted for better spacing on smaller screens */
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        li span {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        #refreshButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            border-radius: 5px;
        }
        #refreshButton:hover {
            background-color: #45a049;
        }
        /* Loading Indicator Styles */
        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }

        /* New class for white text */
        .white-text {
            color: white;
        }

        /* Media Queries for Responsiveness */

        /* Tablets and Small Desktops */
        @media (max-width: 1024px) {
            body {
                margin: 20px;
            }
            h1, h2 {
                font-size: 1.5em;
            }
            #timestamp {
                font-size: 14px;
            }
            li {
                font-size: 14px;
                margin: 5px 8px;
            }
            li span {
                width: 18px;
                height: 18px;
            }
            #refreshButton {
                font-size: 14px;
                padding: 8px 16px;
            }
        }

        /* Mobile Devices */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            h1, h2 {
                font-size: 1.2em;
            }
            #timestamp {
                font-size: 12px;
            }
            li {
                font-size: 12px;
                margin: 5px 5px;
            }
            li span {
                width: 16px;
                height: 16px;
            }
            #refreshButton {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* Very Small Devices (e.g., TVs) */
        @media (min-width: 1200px) {
            body {
                margin: 60px;
            }
            h1, h2 {
                font-size: 2em;
            }
            #timestamp {
                font-size: 18px;
            }
            li {
                font-size: 18px;
                margin: 0 20px;
            }
            li span {
                width: 24px;
                height: 24px;
            }
            #refreshButton {
                font-size: 18px;
                padding: 12px 24px;
            }
        }
    </style>
    <script>
        // Function to refresh the page every 30 seconds
        function autoRefresh() {
            setInterval(function(){
                window.location.reload();
            }, 30000); // 30 seconds
        }

        // Initialize auto-refresh when the page loads
        window.onload = autoRefresh;
    </script>
</head>
<body>
    <h1>Pick Performance Dashboard</h1>
    <div id="timestamp">Last updated: --</div> <!-- Timestamp Element -->
    <div id="pickChartContainer">
        <canvas id="pickChart"></canvas>
    </div>
    
    <button id="refreshButton" onclick="window.location.reload();">Refresh Data</button> <!-- Manual Refresh Button -->
    
    <h2>Color Legend</h2>
    <ul>
        <li><span style="background-color: rgba(54, 162, 235, 1);"></span>Actual Picks (Performance > 120%)</li>
        <li><span style="background-color: rgba(75, 192, 192, 1);"></span>Actual Picks (Performance 100-120%)</li>
        <li><span style="background-color: rgba(255, 205, 86, 0.7);"></span>Actual Picks (Performance 80-100%)</li>
        <li><span style="background-color: rgba(255, 99, 132, 0.7);"></span>Actual Picks (Performance 60-80%)</li>
        <li class="white-text"><span style="background-color: rgba(0, 0, 0, 0.7);"></span>Actual Picks (Performance < 60%)</li>
        <li><span style="background-color: rgba(201, 203, 207, 0.7);"></span>Remaining Expected Picks</li>
    </ul>

    <!-- Loading Indicator -->
    <div id="loading">
        <p>Loading data...</p>
    </div>

    <script>
        // Register the Data Labels plugin
        Chart.register(ChartDataLabels);

        // Initialize global variables
        let pickChart; // To store the Chart.js instance

        // Function to update the timestamp
        function updateTimestamp() {
            const now = new Date();
            const options = {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true
            };
            const formattedTime = now.toLocaleString('en-US', options);
            document.getElementById('timestamp').innerText = `Last updated: ${formattedTime}`;
        }

        // Function to determine font size based on window width
        function getFontSize() {
            const width = window.innerWidth;
            if (width < 480) { // Mobile
                return 10;
            } else if (width < 768) { // Tablets
                return 12;
            } else if (width < 1200) { // Small Desktops
                return 14;
            } else { // Large Screens (TV)
                return 18;
            }
        }

        // Function to fetch data and update the chart
        async function fetchDataAndUpdateChart() {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'block';

                // Fetch data from the backend
                const response = await fetch(`/pick-performance?t=${new Date().getTime()}`);
                const result = await response.json();

                console.log('Fetch Response:', result); // Debugging

                if (result.status === 'success') {
                    let data = result.data;

                    console.log('Fetched Data:', data); // Debugging

                    if (data.length === 0) {
                        console.warn('No data available to display.');
                        // Display a message or handle as needed
                        document.getElementById('pickChartContainer').innerHTML = '<p>No data available to display.</p>';
                        updateTimestamp(); // Update timestamp even if no data
                        document.getElementById('loading').style.display = 'none'; // Hide loading
                        return;
                    }

                    // Sort the data array in descending order based on PerformancePercentage
                    data.sort((a, b) => b.PerformancePercentage - a.PerformancePercentage);

                    // Extract sorted data into respective arrays
                    const labels = data.map(item => item.NAME); // Use NAME instead of PickedBy
                    const actualPicks = data.map(item => item.actualpicked); // Actual Picks
                    const expectedPicks = data.map(item => parseFloat(item.ExpectedPicks));
                    const shifts = data.map(item => item.SHIFT);
                    const performancePercentages = data.map(item => parseFloat(item.PerformancePercentage) || 0);

                    // Find the maximum expected picks
                    const maxExpectedPicks = Math.max(...expectedPicks);

                    // Prepare datasets
                    const adjustedActualPicks = actualPicks.map(value => value); // Actual picks for all users

                    // Replace 'null' with 0 to prevent Chart.js issues
                    const remainingExpectedPicks = expectedPicks.map((value, index) => {
                        const remaining = value - actualPicks[index];
                        return remaining > 0 ? remaining : 0;
                    });

                    // Assign colors based on performance percentage for actual picks
                    const actualBarColors = performancePercentages.map(percentage => {
                        if (percentage > 120) {
                            return 'rgba(54, 162, 235, 0.7)'; // Blue for Performance > 120%
                        } else if (percentage >= 100 && percentage <= 120) {
                            return 'rgba(75, 192, 192, 0.7)'; // Green
                        } else if (percentage >= 80 && percentage < 100) {
                            return 'rgba(255, 205, 86, 0.7)'; // Yellow
                        } else if (percentage >= 60 && percentage < 80) {
                            return 'rgba(255, 99, 132, 0.7)'; // Red
                        } else {
                            return 'rgba(0, 0, 0, 0.7)'; // Black
                        }
                    });

                    if (!pickChart) {
                        // Initialize the chart if it hasn't been created yet
                        const ctx = document.getElementById('pickChart').getContext('2d');
                        pickChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Actual Picks',
                                        data: adjustedActualPicks,
                                        backgroundColor: actualBarColors,
                                        borderColor: actualBarColors.map(color => color.replace('0.7', '1')),
                                        borderWidth: 1,
                                        stack: 'combined',
                                    },
                                    {
                                        label: 'Remaining Expected Picks',
                                        data: remainingExpectedPicks,
                                        backgroundColor: 'rgba(201, 203, 207, 0.7)', // Gray color for remaining expected picks
                                        borderColor: 'rgba(201, 203, 207, 1)',
                                        borderWidth: 1,
                                        stack: 'combined',
                                    },
                                ],
                            },
                            options: {
                                responsive: true, 
                                maintainAspectRatio: false,    
                                indexAxis: 'y', // This makes the bar chart horizontal
                                scales: {
                                    x: {
                                        stacked: true, // Enable stacking for x-axis (since it's horizontal)
                                        beginAtZero: true,
                                        max: maxExpectedPicks, // Set the max to the maximum expected picks
                                        title: {
                                            display: true,
                                            text: 'Number of Picks',
                                            font: {
                                                weight: 'bold',
                                                size: getFontSize() + 2,
                                            },
                                        },
                                        ticks:{
                                            color:'#000',
                                            font: {
                                                weight: 'bold', // This makes the labels bold
                                                size: getFontSize(),
                                            },
                                        }
                                    },
                                    y: {
                                        stacked: true, // Stack the bars on the y-axis
                                        title: {
                                            display: true,
                                            text: 'Name',
                                            font: {
                                                weight: 'bold', // Optional: Make the axis title bold
                                                size: getFontSize() + 2,        // Optional: Adjust the font size
                                            },
                                        },
                                        ticks:{
                                            color:'#000',
                                            font: {
                                                weight: 'bold', // This makes the labels bold
                                                size: getFontSize(),
                                            },
                                        }
                                    },
                                },
                                plugins: {
                                    datalabels: {
                                        anchor: 'center',
                                        align: 'center',
                                        formatter: function(value, context) {
                                            if (context.dataset.label === 'Actual Picks') {
                                                let performance = performancePercentages[context.dataIndex];
                                                
                                                // Cap the performance at 100%
                                                if (performance > 100) {
                                                    performance = 100;
                                                }

                                                return `${performance.toFixed(2)}%`;
                                            }
                                            return '';
                                        },
                                        color: function(context) {
                                            // Get the background color of the current bar
                                            const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                                            
                                            // Check if the background color is black (rgba(0, 0, 0, 0.7))
                                            if (backgroundColor === 'rgba(0, 0, 0, 0.7)') {
                                                return '#FFFFFF'; // White text for black bars
                                            }
                                            return '#000000'; // Black text for other bars
                                        },
                                        font: {
                                            weight: 'bold',
                                            size: getFontSize(), // Dynamically set font size
                                        }
                                    },
                                    legend: {
                                        display: window.innerWidth > 480,
                                        position: 'top',
                                        labels: {
                                            font: {
                                                size: getFontSize(),
                                            },
                                        },
                                    },
                                    title: {
                                        display: true,
                                        text: 'Pick Performance per User',
                                        font: {
                                            size: getFontSize() + 4,
                                            weight: 'bold',
                                        },
                                    },
                                    tooltip: {
                                        callbacks: {
                                            afterLabel: function(context) {
                                                const index = context.dataIndex;
                                                let performance = performancePercentages[index];
                                                
                                                // Cap performance at 100% for display if it's greater than 120%
                                                if (performance > 100) {
                                                    performance = 100;
                                                } else {
                                                    performance = performance.toFixed(2);
                                                }

                                                return [
                                                    'Shift: ' + shifts[index],
                                                    'Performance: ' + performance + '%',
                                                ];
                                            },
                                            label: function(context) {
                                                // Customize label to include both Actual Picks and Remaining Expected Picks
                                                if (context.dataset.label === 'Actual Picks') {
                                                    return `Actual Picks: ${context.parsed.x}`;
                                                } else if (context.dataset.label === 'Remaining Expected Picks') {
                                                    return `Remaining Expected Picks: ${context.parsed.x}`;
                                                }
                                                return context.dataset.label;
                                            }
                                        },
                                    },
                                },
                            },
                            plugins: [ChartDataLabels] // Register the Data Labels plugin
                        });
                        console.log('Chart initialized.');
                    } else {
                        // Update the existing chart with new data
                        pickChart.data.labels = labels;
                        pickChart.data.datasets[0].data = adjustedActualPicks;
                        pickChart.data.datasets[0].backgroundColor = actualBarColors;
                        pickChart.data.datasets[0].borderColor = actualBarColors.map(color => color.replace('0.7', '1'));
                        pickChart.data.datasets[1].data = remainingExpectedPicks;
                        pickChart.options.scales.x.max = maxExpectedPicks; // Update the max for x-axis
                        pickChart.update();
                        console.log('Chart updated.');
                    }

                    // Update the timestamp after successful data fetch
                    updateTimestamp();
                } catch (error) {
                    console.error('Fetch error:', error);
                    // Optionally display an error message to the user
                    document.getElementById('pickChartContainer').innerHTML = '<p>Error loading data.</p>';
                } finally {
                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';
                }
            }

            // Initial data fetch and chart rendering
            fetchDataAndUpdateChart();

            // Set up auto-refresh using setInterval (every 30 seconds)
            setInterval(fetchDataAndUpdateChart, 30000); // 30000 milliseconds = 30 seconds

            // Manual Refresh Button
            document.getElementById('refreshButton').addEventListener('click', () => {
                // Show loading indicator
                document.getElementById('loading').style.display = 'block';
                // Fetch data and update chart
                fetchDataAndUpdateChart();
            });

            // Function to update chart fonts
            function updateChartFonts() {
                if (pickChart) {
                    const newFontSize = getFontSize();
                    pickChart.options.scales.x.ticks.font.size = newFontSize;
                    pickChart.options.scales.x.title.font.size = newFontSize + 2;
                    pickChart.options.scales.y.ticks.font.size = newFontSize;
                    pickChart.options.scales.y.title.font.size = newFontSize + 2;
                    pickChart.options.plugins.datalabels.font.size = newFontSize;
                    if (pickChart.options.plugins.legend) {
                        pickChart.options.plugins.legend.labels = pickChart.options.plugins.legend.labels || {};
                        pickChart.options.plugins.legend.labels.font = pickChart.options.plugins.legend.labels.font || {};
                        pickChart.options.plugins.legend.labels.font.size = newFontSize;
                    }
                    pickChart.update();
                }
            }

            // Update chart fonts on window resize
            window.addEventListener('resize', updateChartFonts);
        </script>
</body>
</html>
